{"componentChunkName":"component---src-templates-blog-post-js","path":"/django-user/","result":{"data":{"site":{"siteMetadata":{"title":"Qin Blog"}},"allMarkdownRemark":{"nodes":[{"id":"287bc4a4-c027-5edf-9b1b-0a5e4fb1491c","excerpt":"Django 是一个由 Python 编写的一个开放源代码的 Web 应用框架。 使用 Django，只要很少的代码，Python 的程序开发人员就可以轻松地完成一个正式网站所需要的大部分内容，并进一步开发出全功能的 Web 服务 Django 本身基于 MVC…","fields":{"slug":"/django/"},"frontmatter":{"date":"March 28, 2021","title":"Django 从开发到部署","description":"Django 项目搭建、部署。","order":50}},{"id":"a8e3a9e3-4e2e-5586-bab5-991527f90849","excerpt":"上一篇 Django 从开发到部署 介绍了 Django 的基本操作。这篇将基于上一篇的代码，来扩展一个用户模块。 该模块基于 Django 自带的 auth 模块进行扩展，并实现了微信扫码登录的后端功能。 模块概览 其中： user/libs: 用户模块相关工具库。 user…","fields":{"slug":"/django-user/"},"frontmatter":{"date":"March 28, 2021","title":"Django -- 用户模块","description":"Django 用户模块搭建，基于JWT的登录登出系统、微信登录对接。","order":51}},{"id":"c9893318-3eaa-576e-87fa-2ae0dc18d4db","excerpt":"NGINX is a free, open-source, high-performance HTTP server and reverse proxy, as well as an IMAP/POP3 proxy server. NGINX is known for its…","fields":{"slug":"/nginx/"},"frontmatter":{"date":"January 27, 2021","title":"Nginx","description":"Nginx 基本操作（安装、启动、升级...）。","order":null}}]},"markdownRemark":{"id":"a8e3a9e3-4e2e-5586-bab5-991527f90849","excerpt":"上一篇 Django 从开发到部署 介绍了 Django 的基本操作。这篇将基于上一篇的代码，来扩展一个用户模块。 该模块基于 Django 自带的 auth 模块进行扩展，并实现了微信扫码登录的后端功能。 模块概览 其中： user/libs: 用户模块相关工具库。 user/libs/jwt: jwt…","html":"<p>上一篇 <a href=\"/django\">Django 从开发到部署</a> 介绍了 Django 的基本操作。这篇将基于上一篇的代码，来扩展一个用户模块。</p>\n<p>该模块基于 Django 自带的 auth 模块进行扩展，并实现了微信扫码登录的后端功能。</p>\n<h3>模块概览</h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 323px; margin: 0;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 101.26582278481011%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1UlEQVQ4y52U2Y7iMBRE+YimG0gI0JAQspjEWezsCT2LRvMwD/MD8/8/UXNtREv0E+YhUqTYR3WrKne2dLZwdnv8KwX6ukF3+Ya95+PNWmO53hg/s4V+ccCKCnHeIckKhOcErytbH1jYjhnwdskNQkw/Oeq2wZkXpNC+O/goeHY9uIXlOPj1h6MaerA0w4qsUN/U6DfYI9DZ7eVlYeEQRpBthO3BR9MP8COGbrxgTR6/mSncaM+OLITsOETdIRMSO/d4p8xI4XxpwydgP6UUjEAhKwQs0VDn/WDqoVK4JmAA2cQIGQcvSoJfIJoWp/j8mfrDwJ3rYfr9FzElfPn+A+0waZjq5HxpmY5MadobyFFif3SR5gJRwnUogYG6L8AtqjFHnFDSTY8kL5CVEieCPg2shwS5yKg6A6ksUVS1HvOJlK9AOWQUBidoTeoEXD+gfq7M/pQ7hWNKwBTt+EHFHmnskkrufS4K41CUhyF1sZCNHpcXAl4QGW2eLwo5jUoLoht1baq210pV4rfqGAFFnyFOGUErHYrpYrgDvlobNJNSmOralLRsD/7pyZTVJWcP0aUIohNy8lApjFP+3IKdL2yEnJFvDO9eSB72pE791911dRmE8h+vSTBk46UIKgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"catalogue\" title=\"catalogue\" src=\"/static/449ae6420c9167b530fedb6f5f0e887d/89aeb/catalogue.png\" srcset=\"/static/449ae6420c9167b530fedb6f5f0e887d/c26ae/catalogue.png 158w,\n/static/449ae6420c9167b530fedb6f5f0e887d/6bdcf/catalogue.png 315w,\n/static/449ae6420c9167b530fedb6f5f0e887d/89aeb/catalogue.png 323w\" sizes=\"(max-width: 323px) 100vw, 323px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<br>\n<p>其中：</p>\n<ul>\n<li><strong>user/libs:</strong> 用户模块相关工具库。</li>\n<li><strong>user/libs/jwt:</strong> jwt 相关工具库，包括 token 的创建、校验、登录状态中间件。</li>\n<li><strong>user/libs/wx_login:</strong> 微信登录相关工具库。</li>\n</ul>\n<p>…</p>\n<blockquote>\n<p>其他文件就是 Django 的套路了，不一一介绍了。</p>\n</blockquote>\n<h3>表结构设计</h3>\n<p>分成两张表，一张是用户表（User），一张是 Oauth 登录信息表（Oauth）。</p>\n<ol>\n<li>User 表</li>\n</ol>\n<p>继承 django.contrib.auth.models.AbstractUser</p>\n<p>nickname 昵称 </br>\navatar<em>url 头像 </br>\ngender 性别 </br>\nphone</em>number 电话号码</p>\n<ol start=\"2\">\n<li>Oauth 表</li>\n</ol>\n<p>user 外键指向某个用户 </br>\noauth<em>type 渠道（微信或者其他渠道） </br>\noauth</em>id 渠道提供的该用户的唯一 id </br>\ncreated<em>time 创建时间 </br>\nlast</em>mod_time 最后修改时间</p>\n<h3>微信扫码登录流程</h3>\n<p>请先阅读官方文档：<a href=\"https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html\">微信登录流程</a>。</p>\n<p>流程已经很清晰了：</p>\n<ol>\n<li>获取 code</li>\n<li>通过 code 获取 access_token</li>\n<li>使用 access_token 去获取用户信息（unionid、用户昵称、用户头像）</li>\n<li>后端将微信 unionid 和 数据库中的用户信息进行对应，完成用户登录</li>\n</ol>\n<h4>前端要做的事情</h4>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 先引入 http://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js</span>\n\n<span class=\"token keyword\">var</span> obj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WxLogin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  self_redirect<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  id<span class=\"token operator\">:</span> <span class=\"token string\">'login_container'</span><span class=\"token punctuation\">,</span>\n  appid<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  scope<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  redirect_uri<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  state<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  style<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  href<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>好好研究上面这段代码的传参，其实已经明确了流程。</p>\n<ol>\n<li>参数 id</li>\n</ol>\n<p>这段代码会在 id 对应的 dom 节点上渲染一个 iframe 元素，在这个 iframe 元素中展示的是登录用的二维码。</p>\n<ol start=\"2\">\n<li>参数 redirect_uri</li>\n</ol>\n<p>在用户扫码之后，点击了确认授权，该 iframe 会发起一个重定向请求到 redirect<em>uri，而在它的 query 中会携带上 code。而这个 redirect</em>uri 便是我们后端要开的一个接口（这边称它为 callback 接口）。</p>\n<p>到这步为止，其实已经完成第一步，后端已经获取到 code 了，二三两步自然能很容易在后端完成。</p>\n<p>那么，还有个问题，后端 callback 接口中处理完 1 ～ 4 步，用户已经登录成功，怎么通知前端页面呢？</p>\n<p>我的方案是：</p>\n<ol>\n<li>后端再提供一个供前端轮询的接口，前端加载出二维码之后开始发起轮询，\b\b 轮询的时候带一个 uuid。如果接口返回中带有 token，表示用户已登录成功，否则继续轮询。</li>\n<li>前端在 redirect_uri 中也带上 1 中的那个 uuid，后端在 callback 接口中获取到该 uuid，以该 uuid 为 key，将登录完成后的 token 存在 redis 中。在 1 的轮询接口中，\n使用 uuid 为 key 去 redis 中查询，如果 token 存在则表明用户已登录，返回 token，否则未登录。</li>\n</ol>\n<blockquote>\n<p>uuid 可以放在 state 参数中，因为 state 参数会自动拼接到 redirect_uri 里去</p>\n</blockquote>\n<h4>后端要做的事情</h4>\n<p>后端需要提供两个接口：</p>\n<ol>\n<li>login/wx/</li>\n<li>login/wx/callback/</li>\n</ol>\n<p>第一个接口供前端轮询是否已经登录成功；第二个接口是用户授权后 iframe 重定向的地址，在该接口中可以获取到 code，进而处理用户登录逻辑。</p>\n<h3>代码实现</h3>\n<p>安装依赖。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">pip <span class=\"token function\">install</span> djangorestframework-jwt channels channels-redis</code></pre></div>\n<p>修改配置。</p>\n<p><strong>main/settings/base.py</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token triple-quoted-string string\">'''\nRedis\n'''</span>\nCHANNEL_LAYERS <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'default'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'BACKEND'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'channels_redis.core.RedisChannelLayer'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'CONFIG'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">'hosts'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token string\">'127.0.0.1'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6379</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\nCACHES <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'default'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'BACKEND'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'django_redis.cache.RedisCache'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'LOCATION'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'redis://127.0.0.1:6379'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'OPTIONS'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">'CLIENT_CLASS'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'django_redis.client.DefaultClient'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nSESSION_ENGINE <span class=\"token operator\">=</span> <span class=\"token string\">'django.contrib.sessions.backends.cache'</span>\nSESSION_CACHE_ALIAS <span class=\"token operator\">=</span> <span class=\"token string\">'default'</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token triple-quoted-string string\">'''\nRest Framework\n'''</span>\nREST_FRAMEWORK <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'DEFAULT_PERMISSION_CLASSES'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'DEFAULT_AUTHENTICATION_CLASSES'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'rest_framework_jwt.authentication.JSONWebTokenAuthentication'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'rest_framework.authentication.SessionAuthentication'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'rest_framework.authentication.BasicAuthentication'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token triple-quoted-string string\">'''\nApplication definition\n'''</span>\nINSTALLED_APPS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'channels'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'apps.user'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\nAUTH_USER_MODEL <span class=\"token operator\">=</span> <span class=\"token string\">'user.User'</span></code></pre></div>\n<p>在 main url 中添加 user 相关路由。</p>\n<p><strong>main/urls.py</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\nurlpatterns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span>\n    path<span class=\"token punctuation\">(</span><span class=\"token string\">'api/user/'</span><span class=\"token punctuation\">,</span> include<span class=\"token punctuation\">(</span><span class=\"token string\">'apps.user.urls'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>main 中的设置基结束了，下面是 user 模块的代码。</p>\n<p>一个模块我习惯先从 models 入手，先定义出对象的数据结构。</p>\n<p><strong>user/models.py</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>db <span class=\"token keyword\">import</span> models\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>timezone <span class=\"token keyword\">import</span> now\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>exceptions <span class=\"token keyword\">import</span> ValidationError\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>translation <span class=\"token keyword\">import</span> gettext_lazy\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> AbstractUser\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>AbstractUser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    nickname <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'昵称'</span><span class=\"token punctuation\">,</span>\n        max_length<span class=\"token operator\">=</span><span class=\"token number\">225</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token string\">''</span>\n    <span class=\"token punctuation\">)</span>\n    avatar <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'头像'</span><span class=\"token punctuation\">,</span>\n        max_length<span class=\"token operator\">=</span><span class=\"token number\">225</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token string\">''</span>\n    <span class=\"token punctuation\">)</span>\n    gender <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'性别'</span><span class=\"token punctuation\">,</span>\n        max_length<span class=\"token operator\">=</span><span class=\"token number\">225</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token string\">''</span>\n    <span class=\"token punctuation\">)</span>\n    phone <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'手机号码'</span><span class=\"token punctuation\">,</span>\n        max_length<span class=\"token operator\">=</span><span class=\"token number\">225</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token string\">''</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">class</span> <span class=\"token class-name\">Meta</span><span class=\"token punctuation\">:</span>\n        verbose_name <span class=\"token operator\">=</span> <span class=\"token string\">'用户'</span>\n        verbose_name_plural <span class=\"token operator\">=</span> verbose_name\n        ordering <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'-date_joined'</span><span class=\"token punctuation\">]</span>\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Oauth</span><span class=\"token punctuation\">(</span>models<span class=\"token punctuation\">.</span>Model<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    OAUTH_TYPE <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">(</span><span class=\"token string\">'weixin'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'微信'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n\n    user <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>ForeignKey<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'user'</span><span class=\"token punctuation\">,</span>\n        related_name<span class=\"token operator\">=</span><span class=\"token string\">'contained_oauths'</span><span class=\"token punctuation\">,</span>\n        on_delete<span class=\"token operator\">=</span>models<span class=\"token punctuation\">.</span>CASCADE\n    <span class=\"token punctuation\">)</span>\n    oauth_type <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'类型'</span><span class=\"token punctuation\">,</span>\n        max_length<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n        choices<span class=\"token operator\">=</span>OAUTH_TYPE<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    oauth_id <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'oauth id'</span><span class=\"token punctuation\">,</span>\n        max_length<span class=\"token operator\">=</span><span class=\"token number\">200</span>\n    <span class=\"token punctuation\">)</span>\n    created_time <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>DateTimeField<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'创建时间'</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span>now\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">clean</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> Oauth<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">(</span>oauth_type<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>oauth_type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>exclude<span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> ValidationError<span class=\"token punctuation\">(</span>gettext_lazy<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>oauth_type <span class=\"token operator\">+</span> <span class=\"token string\">'已经存在'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__str__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>oauth_type\n\n    <span class=\"token keyword\">class</span> <span class=\"token class-name\">Meta</span><span class=\"token punctuation\">:</span>\n        verbose_name <span class=\"token operator\">=</span> <span class=\"token string\">'Oauth 信息'</span>\n        verbose_name_plural <span class=\"token operator\">=</span> <span class=\"token string\">'用户 / Oauth'</span>\n        ordering <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'-created_time'</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p><strong>user/serializers.py</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">from</span> rest_framework <span class=\"token keyword\">import</span> serializers\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> User<span class=\"token punctuation\">,</span> Oauth\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">UserSerializer</span><span class=\"token punctuation\">(</span>serializers<span class=\"token punctuation\">.</span>ModelSerializer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">class</span> <span class=\"token class-name\">Meta</span><span class=\"token punctuation\">:</span>\n        model <span class=\"token operator\">=</span> User\n        fields <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'username'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nickname'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'avatar_url'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'gender'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'phone_number'</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">OauthSerializer</span><span class=\"token punctuation\">(</span>serializers<span class=\"token punctuation\">.</span>ModelSerializer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">class</span> <span class=\"token class-name\">Meta</span><span class=\"token punctuation\">:</span>\n        model <span class=\"token operator\">=</span> Oauth\n        fields <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'user'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'oauth_type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'created_time'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'last_mod_time'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>user/urls.py</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>urls <span class=\"token keyword\">import</span> path\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span> <span class=\"token keyword\">import</span> views\n\nurlpatterns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    path<span class=\"token punctuation\">(</span><span class=\"token string\">'login/wx/'</span><span class=\"token punctuation\">,</span> views<span class=\"token punctuation\">.</span>WeixinLoginView<span class=\"token punctuation\">.</span>as_view<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    path<span class=\"token punctuation\">(</span><span class=\"token string\">'login/wx/callback/'</span><span class=\"token punctuation\">,</span> views<span class=\"token punctuation\">.</span>WeixinLoginCallbackView<span class=\"token punctuation\">.</span>as_view<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    path<span class=\"token punctuation\">(</span><span class=\"token string\">'logout/'</span><span class=\"token punctuation\">,</span> views<span class=\"token punctuation\">.</span>LogoutView<span class=\"token punctuation\">.</span>as_view<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    path<span class=\"token punctuation\">(</span><span class=\"token string\">'current/'</span><span class=\"token punctuation\">,</span> views<span class=\"token punctuation\">.</span>CurrentView<span class=\"token punctuation\">.</span>as_view<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p><strong>user/admin.py</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib <span class=\"token keyword\">import</span> admin\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> User<span class=\"token punctuation\">,</span> Oauth\n\n\n<span class=\"token decorator annotation punctuation\">@admin<span class=\"token punctuation\">.</span>register</span><span class=\"token punctuation\">(</span>User<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">UserAdmin</span><span class=\"token punctuation\">(</span>admin<span class=\"token punctuation\">.</span>ModelAdmin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    list_display <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'username'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nickname'</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token string\">'avatar_url'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'gender'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'phone_number'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'date_joined'</span><span class=\"token punctuation\">]</span>\n    list_display_links <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'username'</span><span class=\"token punctuation\">]</span>\n    ordering <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span>\n\n    empty_value_display <span class=\"token operator\">=</span> <span class=\"token string\">'--'</span>\n\n\n<span class=\"token decorator annotation punctuation\">@admin<span class=\"token punctuation\">.</span>register</span><span class=\"token punctuation\">(</span>Oauth<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">OauthAdmin</span><span class=\"token punctuation\">(</span>admin<span class=\"token punctuation\">.</span>ModelAdmin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    list_display <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'user'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'oauth_type'</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token string\">'oauth_id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'created_time'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'last_mod_time'</span><span class=\"token punctuation\">]</span>\n    list_display_links <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'user'</span><span class=\"token punctuation\">]</span>\n    ordering <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span>\n\n    empty_value_display <span class=\"token operator\">=</span> <span class=\"token string\">'--'</span></code></pre></div>\n<p><strong>user/libs/jwt.py</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">import</span> jwt\n<span class=\"token keyword\">import</span> datetime\n<span class=\"token keyword\">from</span> jwt <span class=\"token keyword\">import</span> exceptions\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>conf <span class=\"token keyword\">import</span> settings\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>cache <span class=\"token keyword\">import</span> cache\n<span class=\"token keyword\">from</span> rest_framework<span class=\"token punctuation\">.</span>authentication <span class=\"token keyword\">import</span> BaseAuthentication\n<span class=\"token keyword\">from</span> rest_framework<span class=\"token punctuation\">.</span>exceptions <span class=\"token keyword\">import</span> AuthenticationFailed\n<span class=\"token keyword\">from</span> apps<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> User\n<span class=\"token keyword\">from</span> apps<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>serializers <span class=\"token keyword\">import</span> UserSerializer\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">checkToken</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    salt <span class=\"token operator\">=</span> settings<span class=\"token punctuation\">.</span>SECRET_KEY\n\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        result <span class=\"token operator\">=</span> jwt<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> salt<span class=\"token punctuation\">,</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span> exceptions<span class=\"token punctuation\">.</span>ExpiredSignatureError<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">'token过期失效'</span>\n    <span class=\"token keyword\">except</span> exceptions<span class=\"token punctuation\">.</span>DecodeError<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">'token认证失败'</span>\n    <span class=\"token keyword\">except</span> exceptions<span class=\"token punctuation\">.</span>InvalidTokenError<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">'无效的token'</span>\n\n    <span class=\"token comment\"># 检查  token 是否在 redis 中存在，防止多设备登录</span>\n    user_id <span class=\"token operator\">=</span> result<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span>\n    user_token_key <span class=\"token operator\">=</span> <span class=\"token string\">'usertoken_%d'</span> <span class=\"token operator\">%</span> user_id\n    <span class=\"token keyword\">if</span> cache<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>user_token_key<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> token<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">'无效的token'</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'result'</span><span class=\"token punctuation\">:</span> result<span class=\"token punctuation\">,</span> <span class=\"token string\">'user_id'</span><span class=\"token punctuation\">:</span> user_id<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">JwtQuertParamsAuthentication</span><span class=\"token punctuation\">(</span>BaseAuthentication<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    使用：在试图类中添加 authentication_classes = [JwtQuertParamsAuthentication]\n    \"\"\"</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">authenticate</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        token <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>META<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'HTTP_IDTOKEN'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n\n        c <span class=\"token operator\">=</span> checkToken<span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token keyword\">is</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> AuthenticationFailed<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1001</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'msg'</span><span class=\"token punctuation\">:</span> c<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        result <span class=\"token operator\">=</span> c<span class=\"token punctuation\">[</span><span class=\"token string\">'result'</span><span class=\"token punctuation\">]</span>\n        user_id <span class=\"token operator\">=</span> c<span class=\"token punctuation\">[</span><span class=\"token string\">'user_id'</span><span class=\"token punctuation\">]</span>\n\n        user <span class=\"token operator\">=</span> User<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token operator\">=</span>user_id<span class=\"token punctuation\">)</span>\n        user_data <span class=\"token operator\">=</span> UserSerializer<span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>data\n        request<span class=\"token punctuation\">.</span>token <span class=\"token operator\">=</span> token\n        request<span class=\"token punctuation\">.</span>user_data <span class=\"token operator\">=</span> user_data\n        request<span class=\"token punctuation\">.</span>user_object <span class=\"token operator\">=</span> user\n\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'result'</span><span class=\"token punctuation\">:</span> result<span class=\"token punctuation\">,</span> <span class=\"token string\">'token'</span><span class=\"token punctuation\">:</span> token<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_token</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    salt <span class=\"token operator\">=</span> settings<span class=\"token punctuation\">.</span>SECRET_KEY\n    headers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'typ'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'jwt_'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'alg'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'HS256'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n    payload<span class=\"token punctuation\">[</span><span class=\"token string\">'exp'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>utcnow<span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> datetime<span class=\"token punctuation\">.</span>timedelta<span class=\"token punctuation\">(</span>days<span class=\"token operator\">=</span><span class=\"token number\">50000</span><span class=\"token punctuation\">)</span>\n    token <span class=\"token operator\">=</span> jwt<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span>\n        payload<span class=\"token operator\">=</span>payload<span class=\"token punctuation\">,</span>\n        key<span class=\"token operator\">=</span>salt<span class=\"token punctuation\">,</span>\n        headers<span class=\"token operator\">=</span>headers\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> token</code></pre></div>\n<p><strong>user/libs/wx_login.py</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">import</span> pickle\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>cache <span class=\"token keyword\">import</span> cache\n<span class=\"token keyword\">from</span> apps<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> User\n<span class=\"token keyword\">from</span> apps<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>serializers <span class=\"token keyword\">import</span> UserSerializer\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">WxLogin</span><span class=\"token punctuation\">:</span>\n    <span class=\"token decorator annotation punctuation\">@staticmethod</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">get_wx_code_map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        key <span class=\"token operator\">=</span> <span class=\"token string\">'WeixinCodeMap'</span>\n\n        res <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> res<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> pickle<span class=\"token punctuation\">.</span>loads<span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\n\n    <span class=\"token decorator annotation punctuation\">@staticmethod</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">set_wx_code_map</span><span class=\"token punctuation\">(</span>wx_code_map<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        key <span class=\"token operator\">=</span> <span class=\"token string\">'WeixinCodeMap'</span>\n\n        cache<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> pickle<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>wx_code_map<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> timeout<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">query</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> uuid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        wx_code_map <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>get_wx_code_map<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        res <span class=\"token operator\">=</span> wx_code_map<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>uuid<span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> res<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">None</span>\n        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">del</span> wx_code_map<span class=\"token punctuation\">[</span>uuid<span class=\"token punctuation\">]</span>\n            self<span class=\"token punctuation\">.</span>set_wx_code_map<span class=\"token punctuation\">(</span>wx_code_map<span class=\"token punctuation\">)</span>\n\n            <span class=\"token keyword\">return</span> res\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> uuid<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        wx_code_map <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>get_wx_code_map<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        wx_code_map<span class=\"token punctuation\">[</span>uuid<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> code\n\n        self<span class=\"token punctuation\">.</span>set_wx_code_map<span class=\"token punctuation\">(</span>uuidmap<span class=\"token punctuation\">)</span>\n\n\nwxlogin <span class=\"token operator\">=</span> WxLogin<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>完成了上面一些列铺垫，终于到了最重要的实现接口的时候了。</p>\n<p><strong>user/views.py</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">import</span> json\n<span class=\"token keyword\">import</span> logging\n<span class=\"token keyword\">import</span> requests\n<span class=\"token keyword\">from</span> uuid <span class=\"token keyword\">import</span> uuid4\n<span class=\"token keyword\">import</span> urllib<span class=\"token punctuation\">.</span>parse <span class=\"token keyword\">as</span> urlparse\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>conf <span class=\"token keyword\">import</span> settings\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>cache <span class=\"token keyword\">import</span> cache\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>shortcuts <span class=\"token keyword\">import</span> render\n<span class=\"token keyword\">from</span> rest_framework<span class=\"token punctuation\">.</span>response <span class=\"token keyword\">import</span> Response\n<span class=\"token keyword\">from</span> rest_framework<span class=\"token punctuation\">.</span>views <span class=\"token keyword\">import</span> APIView\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span>libs<span class=\"token punctuation\">.</span>jwt <span class=\"token keyword\">import</span> get_token<span class=\"token punctuation\">,</span> JwtQuertParamsAuthentication\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span>libs<span class=\"token punctuation\">.</span>wx_login <span class=\"token keyword\">import</span> wxlogin\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> User<span class=\"token punctuation\">,</span> Oauth\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span>serializers <span class=\"token keyword\">import</span> UserSerializer<span class=\"token punctuation\">,</span> OauthSerializer\n\nlogger <span class=\"token operator\">=</span> logging<span class=\"token punctuation\">.</span>getLogger<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">WeixinLoginView</span><span class=\"token punctuation\">(</span>APIView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">get_token_info</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        url <span class=\"token operator\">=</span> <span class=\"token string\">'https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code'</span>\n        url <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'APPID'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'your appid'</span><span class=\"token punctuation\">)</span>\n        url <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'SECRET'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'your secret'</span><span class=\"token punctuation\">)</span>\n        url <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'CODE'</span><span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span>\n        res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> res\n\n    <span class=\"token comment\"># 用 access_token 和 openid 去换取微信用户信息</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">get_wx_user_info</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> access_token<span class=\"token punctuation\">,</span> openid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        url <span class=\"token operator\">=</span> <span class=\"token string\">'https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&amp;openid=OPENID'</span>\n        url <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'ACCESS_TOKEN'</span><span class=\"token punctuation\">,</span> access_token<span class=\"token punctuation\">)</span>\n        url <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'OPENID'</span><span class=\"token punctuation\">,</span> openid<span class=\"token punctuation\">)</span>\n        res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> res\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">set_token_to_cache</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> user_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        user_token_key <span class=\"token operator\">=</span> <span class=\"token string\">'userToken_%d'</span> <span class=\"token operator\">%</span> user_id\n        <span class=\"token comment\"># 设置一条永不过期的记录，以后每次 login 都会刷新这条记录</span>\n        cache<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>user_token_key<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> timeout<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        querys <span class=\"token operator\">=</span> urlparse<span class=\"token punctuation\">.</span>parse_qs<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>META<span class=\"token punctuation\">[</span><span class=\"token string\">'QUERY_STRING'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        uuid <span class=\"token operator\">=</span> querys<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'uuid'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n\n        <span class=\"token keyword\">if</span> uuid <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'params-error'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'msg'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'缺少参数 uuid'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n        code <span class=\"token operator\">=</span> wxlogin<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">(</span>uuid<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> code <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'data'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'msg'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'找不到该 uuid 匹配的 code'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># 根据 code 获取 accesstoken</span>\n        token_info <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>get_token_info<span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span>\n        errcode <span class=\"token operator\">=</span> token_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'errcode'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> errcode <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            errmsg <span class=\"token operator\">=</span> token_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'errmsg'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n            logger<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">(</span><span class=\"token string\">'[获取 AccessToken 失败] errcode: '</span> <span class=\"token operator\">+</span>\n                         <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>errcode<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">', errmsg: '</span> <span class=\"token operator\">+</span> errmsg<span class=\"token punctuation\">)</span>\n\n            <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">:</span> errcode<span class=\"token punctuation\">,</span> <span class=\"token string\">'msg'</span><span class=\"token punctuation\">:</span> errmsg<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n        access_token <span class=\"token operator\">=</span> token_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'access_token'</span><span class=\"token punctuation\">)</span>\n        openid <span class=\"token operator\">=</span> token_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'openid'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># 用 access_token 和 openid 去换取微信用户信息</span>\n        wx_user_info <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>get_wx_user_info<span class=\"token punctuation\">(</span>access_token<span class=\"token punctuation\">,</span> openid<span class=\"token punctuation\">)</span>\n        errcode <span class=\"token operator\">=</span> wx_user_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'errcode'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> errcode <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            errmsg <span class=\"token operator\">=</span> wx_user_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'errmsg'</span><span class=\"token punctuation\">)</span>\n            logger<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">(</span><span class=\"token string\">'[获取微信用户信息失败] errcode: '</span> <span class=\"token operator\">+</span>\n                         <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>errcode<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">', errmsg: '</span> <span class=\"token operator\">+</span> errmsg<span class=\"token punctuation\">)</span>\n\n            <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">:</span> errcode<span class=\"token punctuation\">,</span> <span class=\"token string\">'msg'</span><span class=\"token punctuation\">:</span> errmsg<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n        unionid <span class=\"token operator\">=</span> wx_user_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'unionid'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># 从 Oauth.user 中获取用户信息，若 Oauth 不存在则同时创建 Oauth 和 User</span>\n        user <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n        oauth <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n        <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n            oauth <span class=\"token operator\">=</span> Oauth<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>oauth_type<span class=\"token operator\">=</span><span class=\"token string\">'weixin'</span><span class=\"token punctuation\">,</span> oauth_id<span class=\"token operator\">=</span>unionid<span class=\"token punctuation\">)</span>\n            oauth_data <span class=\"token operator\">=</span> OauthSerializer<span class=\"token punctuation\">(</span>oauth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>data\n            user_id <span class=\"token operator\">=</span> oauth_data<span class=\"token punctuation\">[</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">]</span>\n            user <span class=\"token operator\">=</span> User<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>pk<span class=\"token operator\">=</span>user_id<span class=\"token punctuation\">)</span>\n            user<span class=\"token punctuation\">.</span>nickname <span class=\"token operator\">=</span> wx_user_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>\n                <span class=\"token string\">'nickname'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">\"iso-8859-1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            user<span class=\"token punctuation\">.</span>avatar_url <span class=\"token operator\">=</span> wx_user_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'headimgurl'</span><span class=\"token punctuation\">)</span>\n            user<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">except</span> Oauth<span class=\"token punctuation\">.</span>DoesNotExist<span class=\"token punctuation\">:</span>\n            user <span class=\"token operator\">=</span> User<span class=\"token punctuation\">(</span>\n                username<span class=\"token operator\">=</span><span class=\"token string\">'user_'</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>uuid4<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                nickname<span class=\"token operator\">=</span>wx_user_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'nickname'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                gender<span class=\"token operator\">=</span><span class=\"token string\">'男'</span> <span class=\"token keyword\">if</span> wx_user_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'sex'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token keyword\">else</span> <span class=\"token string\">'女'</span><span class=\"token punctuation\">,</span>\n                avatar_url<span class=\"token operator\">=</span>wx_user_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'headimgurl'</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span>\n            user<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            oauth <span class=\"token operator\">=</span> Oauth<span class=\"token punctuation\">(</span>oauth_type<span class=\"token operator\">=</span><span class=\"token string\">'weixin'</span><span class=\"token punctuation\">,</span> oauth_id<span class=\"token operator\">=</span>unionid<span class=\"token punctuation\">,</span> user<span class=\"token operator\">=</span>user<span class=\"token punctuation\">)</span>\n            oauth<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        oauth_data <span class=\"token operator\">=</span> OauthSerializer<span class=\"token punctuation\">(</span>oauth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>data\n        user_data <span class=\"token operator\">=</span> UserSerializer<span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>data\n\n        <span class=\"token comment\"># 使用 user.id 和 user.username 生成 jwt token</span>\n        payload <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">'id'</span><span class=\"token punctuation\">:</span> user_data<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'username'</span><span class=\"token punctuation\">:</span> user_data<span class=\"token punctuation\">[</span><span class=\"token string\">'username'</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n        token <span class=\"token operator\">=</span> get_token<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># 将 jwt 存到 redis 中，防止重复登录</span>\n        self<span class=\"token punctuation\">.</span>set_token_to_cache<span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'data'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'token'</span><span class=\"token punctuation\">:</span> token<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">WeixinLoginCallbackView</span><span class=\"token punctuation\">(</span>APIView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        querys <span class=\"token operator\">=</span> urlparse<span class=\"token punctuation\">.</span>parse_qs<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>META<span class=\"token punctuation\">[</span><span class=\"token string\">'QUERY_STRING'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        uuid <span class=\"token operator\">=</span> querys<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'state'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n        code <span class=\"token operator\">=</span> querys<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n\n        <span class=\"token keyword\">if</span> code <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'params-error'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'msg'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'缺少参数 code'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> uuid <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'params-error'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'msg'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'缺少参数 uuid'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n        wxlogin<span class=\"token punctuation\">.</span>update<span class=\"token punctuation\">(</span>uuid<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span>\n\n        response <span class=\"token operator\">=</span> render<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> <span class=\"token string\">'wx-login-success.html'</span><span class=\"token punctuation\">)</span>\n        response<span class=\"token punctuation\">[</span><span class=\"token string\">'X-Frame-Options'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'ALLOW-FROM http://localhost/'</span>\n\n        <span class=\"token keyword\">return</span> response\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">LogoutView</span><span class=\"token punctuation\">(</span>APIView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    authentication_classes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>JwtQuertParamsAuthentication<span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">remove_token_from_cache</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> user_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        user_token_key <span class=\"token operator\">=</span> <span class=\"token string\">'userToken_%d'</span> <span class=\"token operator\">%</span> user_id\n        cache<span class=\"token punctuation\">.</span>delete_pattern<span class=\"token punctuation\">(</span>user_token_key<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">post</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        user_data <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>user_data\n        token <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>token\n\n        user_id <span class=\"token operator\">=</span> user_data<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span>\n        self<span class=\"token punctuation\">.</span>remove_token_from_cache<span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> user_id<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'msg'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'登出成功'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">CurrentView</span><span class=\"token punctuation\">(</span>APIView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    authentication_classes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>JwtQuertParamsAuthentication<span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        user_data <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>user_data\n\n        <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'data'</span><span class=\"token punctuation\">:</span> user_data<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>理论上你只需要替换 APPID 和 SECRET 就能使用了，但是这边还有一个小东西，即 <code class=\"language-text\">response = render(request, &#39;wx-login-success.html&#39;)</code> 这行小代码，我们可以把登录成功之后 iframe 需要展示的内容在接口中返回。这边利用 django 的 render 方法渲染了一个 html 模版，将渲染后的 html 格式的字符串返回。这样，iframe 里原来显示的是二维码，然后用户授权发起重定向，登录成功之后就会显示出我们后端 callback 接口返回的 html。</p>\n<p><strong>templates/wx-login-success.html</strong></p>\n<blockquote>\n<p>templates 放在根目录下, wx-login-success.html 样式只是作为参考，可以自由发挥。</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>登录成功<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/css<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\">\n      <span class=\"token selector\">body</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">position</span><span class=\"token punctuation\">:</span> relative<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 100vh<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">overflow</span><span class=\"token punctuation\">:</span> hidden<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token selector\">.container</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 50%<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">position</span><span class=\"token punctuation\">:</span> absolute<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">text-align</span><span class=\"token punctuation\">:</span> center<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">top</span><span class=\"token punctuation\">:</span> 50%<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">left</span><span class=\"token punctuation\">:</span> 50%<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">transform</span><span class=\"token punctuation\">:</span> <span class=\"token function\">translate</span><span class=\"token punctuation\">(</span>-50%<span class=\"token punctuation\">,</span> -50%<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token selector\">.icon</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 60%<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">overflow</span><span class=\"token punctuation\">:</span> hidden<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">vertical-align</span><span class=\"token punctuation\">:</span> middle<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token selector\">.tip</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">font-size</span><span class=\"token punctuation\">:</span> 3em<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>svg</span>\n        <span class=\"token attr-name\">t</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1615970048484<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>icon<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">viewBox</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0 0 1024 1024<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1.1<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">xmlns</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://www.w3.org/2000/svg<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">p-id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>5130<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">data-spm-anchor-id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>a313x.7781069.0.i1<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>path</span>\n          <span class=\"token attr-name\">d</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>M512 952.32c243.17952 0 440.32-197.14048 440.32-440.32s-197.14048-440.32-440.32-440.32-440.32 197.14048-440.32 440.32 197.14048 440.32 440.32 440.32z m0 46.08c-268.63104 0-486.4-217.76896-486.4-486.4S243.36896 25.6 512 25.6s486.4 217.76896 486.4 486.4-217.76896 486.4-486.4 486.4z m-315.04384-472.23808a23.04 23.04 0 1 1 36.16768-28.55424l149.66272 189.54752a17.92 17.92 0 0 0 26.63424 1.66912l352.6656-346.84928a23.04 23.04 0 0 1 32.3072 32.84992l-352.6656 346.8544a64 64 0 0 1-5.21216 4.59776c-27.74016 21.90848-67.98848 17.1776-89.89184-10.56768l-149.66784-189.5424z<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">fill</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>#88D0AD<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">p-id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>5131<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>path</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>svg</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>tip<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>微信登录成功<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>","frontmatter":{"title":"Django -- 用户模块","date":"March 28, 2021","description":"Django 用户模块搭建，基于JWT的登录登出系统、微信登录对接。"}}},"pageContext":{"id":"a8e3a9e3-4e2e-5586-bab5-991527f90849","previousPostId":"c9893318-3eaa-576e-87fa-2ae0dc18d4db","nextPostId":"287bc4a4-c027-5edf-9b1b-0a5e4fb1491c"}},"staticQueryHashes":["2755755109","2841359383"]}
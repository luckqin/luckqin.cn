{"componentChunkName":"component---src-templates-blog-post-js","path":"/django-user/","result":{"data":{"site":{"siteMetadata":{"title":"Qin Blog"}},"allMarkdownRemark":{"nodes":[{"id":"287bc4a4-c027-5edf-9b1b-0a5e4fb1491c","excerpt":"Django 是一个由 Python 编写的一个开放源代码的 Web 应用框架。 使用 Django，只要很少的代码，Python 的程序开发人员就可以轻松地完成一个正式网站所需要的大部分内容，并进一步开发出全功能的 Web 服务 Django 本身基于 MVC…","fields":{"slug":"/django/"},"frontmatter":{"date":"March 28, 2021","title":"Django 从开发到部署","description":"Django 项目搭建、部署。","order":50}},{"id":"a8e3a9e3-4e2e-5586-bab5-991527f90849","excerpt":"上一篇 Django 从开发到部署 介绍了 Django 的基本操作。这篇将基于上一篇的代码，来扩展一个用户模块。 该模块基于 Django 自带的 auth 模块进行扩展，并实现了微信扫码登录的后端功能。 模块概览 其中： user/libs: 用户模块相关工具库。 user…","fields":{"slug":"/django-user/"},"frontmatter":{"date":"March 28, 2021","title":"Django -- 用户模块","description":"Django 用户模块搭建，基于JWT的登录登出系统、微信登录对接。","order":51}},{"id":"c9893318-3eaa-576e-87fa-2ae0dc18d4db","excerpt":"NGINX is a free, open-source, high-performance HTTP server and reverse proxy, as well as an IMAP/POP3 proxy server. NGINX is known for its…","fields":{"slug":"/nginx/"},"frontmatter":{"date":"January 27, 2021","title":"Nginx","description":"Nginx 基本操作（安装、启动、升级...）。","order":null}}]},"markdownRemark":{"id":"a8e3a9e3-4e2e-5586-bab5-991527f90849","excerpt":"上一篇 Django 从开发到部署 介绍了 Django 的基本操作。这篇将基于上一篇的代码，来扩展一个用户模块。 该模块基于 Django 自带的 auth 模块进行扩展，并实现了微信扫码登录的后端功能。 模块概览 其中： user/libs: 用户模块相关工具库。 user/libs/jwt: jwt…","html":"<p>上一篇 <a href=\"/django\">Django 从开发到部署</a> 介绍了 Django 的基本操作。这篇将基于上一篇的代码，来扩展一个用户模块。</p>\n<p>该模块基于 Django 自带的 auth 模块进行扩展，并实现了微信扫码登录的后端功能。</p>\n<h3>模块概览</h3>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 323px; margin: 0;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 101.26582278481011%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1UlEQVQ4y52U2Y7iMBRE+YimG0gI0JAQspjEWezsCT2LRvMwD/MD8/8/UXNtREv0E+YhUqTYR3WrKne2dLZwdnv8KwX6ukF3+Ya95+PNWmO53hg/s4V+ccCKCnHeIckKhOcErytbH1jYjhnwdskNQkw/Oeq2wZkXpNC+O/goeHY9uIXlOPj1h6MaerA0w4qsUN/U6DfYI9DZ7eVlYeEQRpBthO3BR9MP8COGbrxgTR6/mSncaM+OLITsOETdIRMSO/d4p8xI4XxpwydgP6UUjEAhKwQs0VDn/WDqoVK4JmAA2cQIGQcvSoJfIJoWp/j8mfrDwJ3rYfr9FzElfPn+A+0waZjq5HxpmY5MadobyFFif3SR5gJRwnUogYG6L8AtqjFHnFDSTY8kL5CVEieCPg2shwS5yKg6A6ksUVS1HvOJlK9AOWQUBidoTeoEXD+gfq7M/pQ7hWNKwBTt+EHFHmnskkrufS4K41CUhyF1sZCNHpcXAl4QGW2eLwo5jUoLoht1baq210pV4rfqGAFFnyFOGUErHYrpYrgDvlobNJNSmOralLRsD/7pyZTVJWcP0aUIohNy8lApjFP+3IKdL2yEnJFvDO9eSB72pE791911dRmE8h+vSTBk46UIKgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"catalogue\" title=\"catalogue\" src=\"/static/449ae6420c9167b530fedb6f5f0e887d/89aeb/catalogue.png\" srcset=\"/static/449ae6420c9167b530fedb6f5f0e887d/c26ae/catalogue.png 158w,\n/static/449ae6420c9167b530fedb6f5f0e887d/6bdcf/catalogue.png 315w,\n/static/449ae6420c9167b530fedb6f5f0e887d/89aeb/catalogue.png 323w\" sizes=\"(max-width: 323px) 100vw, 323px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<br>\n<p>其中：</p>\n<ul>\n<li><strong>user/libs:</strong> 用户模块相关工具库。</li>\n<li><strong>user/libs/jwt:</strong> jwt 相关工具库，包括 token 的创建、校验、登录状态中间件。</li>\n<li><strong>user/libs/wx_login:</strong> 微信登录相关工具库。</li>\n</ul>\n<p>…</p>\n<blockquote>\n<p>其他文件就是 Django 的套路了，不一一介绍了。</p>\n</blockquote>\n<h3>表结构设计</h3>\n<p>分成两张表，一张是用户表（User），一张是 Oauth 登录信息表（Oauth）。</p>\n<ol>\n<li>User 表</li>\n</ol>\n<p>继承 django.contrib.auth.models.AbstractUser</p>\n<p>nickname 昵称 </br>\navatar<em>url 头像 </br>\ngender 性别 </br>\nphone</em>number 电话号码</p>\n<ol start=\"2\">\n<li>Oauth 表</li>\n</ol>\n<p>user 外键指向某个用户 </br>\noauth<em>type 渠道（微信或者其他渠道） </br>\noauth</em>id 渠道提供的该用户的唯一 id </br>\ncreated<em>time 创建时间 </br>\nlast</em>mod_time 最后修改时间</p>\n<h3>微信扫码登录流程</h3>\n<p>请先阅读官方文档：<a href=\"https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html\">微信登录流程</a>。</p>\n<p>流程已经很清晰了：</p>\n<ol>\n<li>获取 code</li>\n<li>通过 code 获取 access_token</li>\n<li>使用 access_token 去获取用户信息（unionid、用户昵称、用户头像）</li>\n<li>后端将微信 unionid 和 数据库中的用户信息进行对应，完成用户登录</li>\n</ol>\n<h4>前端要做的事情</h4>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 先引入 http://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js</span>\n\n<span class=\"token keyword\">var</span> obj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WxLogin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  self_redirect<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  id<span class=\"token operator\">:</span> <span class=\"token string\">'login_container'</span><span class=\"token punctuation\">,</span>\n  appid<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  scope<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  redirect_uri<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  state<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  style<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  href<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>好好研究上面这段代码的传参，其实已经明确了流程。</p>\n<ol>\n<li>参数 id</li>\n</ol>\n<p>这段代码会在 id 对应的 dom 节点上渲染一个 iframe 元素，在这个 iframe 元素中展示的是登录用的二维码。</p>\n<ol start=\"2\">\n<li>参数 redirect_uri</li>\n</ol>\n<p>在用户扫码之后，点击了确认授权，该 iframe 会发起一个重定向请求到 redirect<em>uri，而在它的 query 中会携带上 code。而这个 redirect</em>uri 便是我们后端要开的一个接口（这边称它为 callback 接口）。</p>\n<p>到这步为止，其实已经完成第一步，后端已经获取到 code 了，二三两步自然能很容易在后端完成。</p>\n<p>那么，还有个问题，后端 callback 接口中处理完 1 ～ 4 步，用户已经登录成功，怎么通知前端页面呢？</p>\n<p>我的方案是：</p>\n<ol>\n<li>后端再提供一个供前端轮询的接口，前端加载出二维码之后开始发起轮询，\b\b 轮询的时候带一个 uuid。如果接口返回中带有 token，表示用户已登录成功，否则继续轮询。</li>\n<li>前端在 redirect_uri 中也带上 1 中的那个 uuid，后端在 callback 接口中获取到该 uuid，以该 uuid 为 key，将登录完成后的 token 存在 redis 中。在 1 的轮询接口中，\n使用 uuid 为 key 去 redis 中查询，如果 token 存在则表明用户已登录，返回 token，否则未登录。</li>\n</ol>\n<blockquote>\n<p>uuid 可以放在 state 参数中，因为 state 参数会自动拼接到 redirect_uri 里去</p>\n</blockquote>\n<h4>后端要做的事情</h4>\n<p>后端需要提供两个接口：</p>\n<ol>\n<li>login/wx/</li>\n<li>login/wx/callback/</li>\n</ol>\n<p>第一个接口供前端轮询是否已经登录成功；第二个接口是用户授权后 iframe 重定向的地址，在该接口中可以获取到 code，进而处理用户登录逻辑。</p>\n<h3>代码实现</h3>\n<p>安装依赖。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">pip <span class=\"token function\">install</span> djangorestframework-jwt channels channels-redis</code></pre></div>\n<p>修改配置。</p>\n<p><strong>main/settings/base.py</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token triple-quoted-string string\">'''\nRedis\n'''</span>\nCHANNEL_LAYERS <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'default'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'BACKEND'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'channels_redis.core.RedisChannelLayer'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'CONFIG'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">'hosts'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token string\">'127.0.0.1'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6379</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\nCACHES <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'default'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'BACKEND'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'django_redis.cache.RedisCache'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'LOCATION'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'redis://127.0.0.1:6379'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'OPTIONS'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">'CLIENT_CLASS'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'django_redis.client.DefaultClient'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nSESSION_ENGINE <span class=\"token operator\">=</span> <span class=\"token string\">'django.contrib.sessions.backends.cache'</span>\nSESSION_CACHE_ALIAS <span class=\"token operator\">=</span> <span class=\"token string\">'default'</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token triple-quoted-string string\">'''\nRest Framework\n'''</span>\nREST_FRAMEWORK <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'DEFAULT_PERMISSION_CLASSES'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'DEFAULT_AUTHENTICATION_CLASSES'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'rest_framework_jwt.authentication.JSONWebTokenAuthentication'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'rest_framework.authentication.SessionAuthentication'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'rest_framework.authentication.BasicAuthentication'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token triple-quoted-string string\">'''\nApplication definition\n'''</span>\nINSTALLED_APPS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'channels'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'apps.user'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\nAUTH_USER_MODEL <span class=\"token operator\">=</span> <span class=\"token string\">'user.User'</span></code></pre></div>\n<p>在 main url 中添加 user 相关路由。</p>\n<p><strong>main/urls.py</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\nurlpatterns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span>\n    path<span class=\"token punctuation\">(</span><span class=\"token string\">'api/user/'</span><span class=\"token punctuation\">,</span> include<span class=\"token punctuation\">(</span><span class=\"token string\">'apps.user.urls'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span></code></pre></div>","frontmatter":{"title":"Django -- 用户模块","date":"March 28, 2021","description":"Django 用户模块搭建，基于JWT的登录登出系统、微信登录对接。"}}},"pageContext":{"id":"a8e3a9e3-4e2e-5586-bab5-991527f90849","previousPostId":"c9893318-3eaa-576e-87fa-2ae0dc18d4db","nextPostId":"287bc4a4-c027-5edf-9b1b-0a5e4fb1491c"}},"staticQueryHashes":["2755755109","2841359383"]}
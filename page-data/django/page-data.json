{"componentChunkName":"component---src-templates-blog-post-js","path":"/django/","result":{"data":{"site":{"siteMetadata":{"title":"Qin Blog"}},"markdownRemark":{"id":"287bc4a4-c027-5edf-9b1b-0a5e4fb1491c","excerpt":"Django 是一个由 Python 编写的一个开放源代码的 Web 应用框架。 使用 Django，只要很少的代码，Python 的程序开发人员就可以轻松地完成一个正式网站所需要的大部分内容，并进一步开发出全功能的 Web 服务 Django 本身基于 MVC 模型，即 Model（模型）+ View…","html":"<p>Django 是一个由 Python 编写的一个开放源代码的 Web 应用框架。</p>\n<p>使用 Django，只要很少的代码，Python 的程序开发人员就可以轻松地完成一个正式网站所需要的大部分内容，并进一步开发出全功能的 Web 服务 Django 本身基于 MVC 模型，即 Model（模型）+ View（视图）+ Controller（控制器）设计模式，MVC 模式使后续对程序的修改和扩展简化，并且使程序某一部分的重复利用成为可能。</p>\n<h2>本地开发篇</h2>\n<h3>1. 环境搭建</h3>\n<blockquote>\n<p>安装过程在 mac 系统下进行。</p>\n</blockquote>\n<p>本地安装 <a href=\"https://www.python.org/ftp/python/3.9.2/python-3.9.2-macosx10.9.pkg\">python 3.9</a>，一路下一步直到安装完成。</p>\n<p>创建虚拟环境。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">python3.9 -m pip <span class=\"token function\">install</span> --upgrade pip\npython3.9 -m pip <span class=\"token function\">install</span> virtualenv\npython3.9 -m pip <span class=\"token function\">install</span> virtualenvwrapper\n\n<span class=\"token comment\"># 找到 virtualenvwrapper 和 python3.9 的路径</span>\n<span class=\"token function\">which</span> virtualenvwrapper.sh\n<span class=\"token function\">which</span> python3.9\n\n<span class=\"token comment\"># 编辑 zshrc</span>\n<span class=\"token function\">vim</span> ~/.zshrc\n<span class=\"token comment\"># 加入以下内容</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">WORKON_HOME</span><span class=\"token operator\">=</span><span class=\"token string\">'~/.virtualenvs'</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">VIRTUALENVWRAPPER_PYTHON</span><span class=\"token operator\">=</span><span class=\"token string\">'/Library/Frameworks/Python.framework/Versions/3.9/bin/python3.9'</span>\n<span class=\"token builtin class-name\">source</span> /Library/Frameworks/Python.framework/Versions/3.9/bin/virtualenvwrapper.sh\n\n<span class=\"token builtin class-name\">source</span> ～/.zshrc\n\n<span class=\"token comment\"># 创建虚拟环境</span>\nmkvirtualenv -p python3.9 django-demo\nworkon django-demo</code></pre></div>\n<h3>2. 安装依赖</h3>\n<p>安装 Django 并使用相关命令初始化一个 Django 项目。</p>\n<blockquote>\n<p>Django == 3.1.7</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">pip <span class=\"token function\">install</span> django djangorestframework\ndjango-admin startproject django_demo</code></pre></div>\n<p>启动项目。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">python manage.py runserver</code></pre></div>\n<h3>3. 调整项目结构</h3>\n<p>初始项目结构很难满足复杂项目的需求，需要对目录结构进行改造。</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 454px; margin: 0;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 108.22784810126582%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAABYlAAAWJQFJUiTwAAACEUlEQVQ4y52VSY+bQBCF5xopt4ltdgzYrMbszY7Ho0iJcpkoSqRcc8j//wlvqluKZWekBHNoEAY+1+t6r3jY6CZMy8HvJMfIGuRNB9PZY63qkOjeRjPE+X/rz3MP/KAT8PP4BFZVaMcTDHuHlaJdHpoDvQEatgN//AiXTShZDdsLoG5tsa6h/wJfgFyyrCiQijPs6RmuuwfrBtRdD9Z20Kj6uyrkQI3v13CG8uUb2rpBM0woaD/v2ccbyRtZg5kXCM8t/CBCUbc4pLmQfg2dJVkyTHwg4C4O0A4uvDBGWlaIkhRBnFyA8ysk4ErWCehheApR1j360wl+fMSjpMyq7o1kDnTiEPUY4kB+zKnTluvNru4GKHPJkg6bJA/PEZKce3FCeEywWgLkh7VqICt2ZJU9VdehIruExxTrmSn5aw+3lBQbv3646IYadT8JuY+yujB6BORJ+V4cUGYpMvJfVjHI9PtiH/KXX1wZeXxAQ1mu+0FYZvFw4BeZHyCIYgErmxZJUYk/WgSU6OLd+BNe1aNijJLSCGMvlrxWTXw9vUdRxlQZQ0UV8k7rNMbmQm+NrW6RTTHy6kiggSI4Ctm26y+Inqhwi0+jiywNqcOtAGYlg3M1HO4aXwql5ewYSKMDErJMSB3mOZ47ad4OWFovkYWCbMO/KQVl2aGuL44eX7ZJHysyuOOHsPYeFNOabZlr4Cv9u2HpyvfwpQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"catalogue\" title=\"catalogue\" src=\"/static/5a18f369f39251cf891fd76ec439f637/b3c1d/catalogue.png\" srcset=\"/static/5a18f369f39251cf891fd76ec439f637/c26ae/catalogue.png 158w,\n/static/5a18f369f39251cf891fd76ec439f637/6bdcf/catalogue.png 315w,\n/static/5a18f369f39251cf891fd76ec439f637/b3c1d/catalogue.png 454w\" sizes=\"(max-width: 454px) 100vw, 454px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<br>\n<p>按 Django 的说法，整个项目是一个大的 project，里面包含了若干应用。</p>\n<p>但我更喜欢称整个项目为一个后台应用，比如 XX 产品的后台应用，而里面包含的若干应用我则称他们为应用中的模块。</p>\n<p>其中：</p>\n<ul>\n<li><strong>main:</strong> 应用主模块，里面包含了应用设置、asgi、wsgi 和路由文件，是整个应用的入口。</li>\n<li><strong>main/settings:</strong> 项目配置，从原本的 <code class=\"language-text\">settings.py</code> 改成了 python 模块的形式，应对本地和服务器不同环境的配置。</li>\n<li><strong>apps:</strong> 应用中模块的集合。</li>\n<li><strong>static:</strong> 静态资源存放的位置。</li>\n<li><strong>upload:</strong> 上传文件存放的位置，文件上传一般在 admin 端的场景比较多。</li>\n<li><strong>circus.ini:</strong> circus 是一个进程管理工具，跑在服务器上，这个文件里写着它的配置。</li>\n<li><strong>run.sh</strong> 本地操作项目相关命令。</li>\n<li><strong>run.sh</strong> 服务器操作项目相关命令。</li>\n</ul>\n<h4>main/settings</h4>\n<p>settings 目录的结构如下。</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 454px; margin: 0;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 33.54430379746836%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA+klEQVQoz5WR206DQBRF5xuMvQnDUEpL6QWKMNx7MZq+oTGN8f+/ZDnoB0gf1nnaOTlnLzGTChmEPHRf7HRF1bTkVcNiveFxZjFzXKYmM4SJ7SD6MZUuTntkn8dsdhG6qs3CEOn5jJ5sxpYcxMiyEd5yjfICEh1xvGyJk4K8bNBFTapL5NzH9QPcxT+YjPJWiKq6kOsz5+sbn7dXPt6/6bob12tHlrUUxWkwWdYgHPOWpXy2mbnwJeJZ1zSnM1GSYruLu7CUh+jLHFuK5WFDcQzZHzLyuibcx7+99B2PbTkMkxe9xYk9Zx2vqNuAOC0pjendIeFPmLrL8g93B8sMLUM0BwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"settings\" title=\"settings\" src=\"/static/c35022540a2a1d871d31f1e5268e7aac/b3c1d/settings.png\" srcset=\"/static/c35022540a2a1d871d31f1e5268e7aac/c26ae/settings.png 158w,\n/static/c35022540a2a1d871d31f1e5268e7aac/6bdcf/settings.png 315w,\n/static/c35022540a2a1d871d31f1e5268e7aac/b3c1d/settings.png 454w\" sizes=\"(max-width: 454px) 100vw, 454px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<br>\n<p><strong>main/settings/base.py</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">from</span> pathlib <span class=\"token keyword\">import</span> Path\n\n<span class=\"token triple-quoted-string string\">'''\nBase Settings\n'''</span>\nBASE_DIR <span class=\"token operator\">=</span> Path<span class=\"token punctuation\">(</span>__file__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>resolve<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>parent\nSECRET_KEY <span class=\"token operator\">=</span> <span class=\"token string\">'pn^36-v(tvw=52%&amp;kqb+t9h4iwrwiiv#xsic+7#69y^_57%&amp;nb'</span>\nWSGI_APPLICATION <span class=\"token operator\">=</span> <span class=\"token string\">'main.wsgi.application'</span>\nASGI_APPLICATION <span class=\"token operator\">=</span> <span class=\"token string\">'main.asgi.application'</span>\n\n\n<span class=\"token triple-quoted-string string\">'''\nInternationalization\n'''</span>\nUSE_TZ <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\nUSE_L10N <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\nUSE_I18N <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\nFILE_CHARSET <span class=\"token operator\">=</span> <span class=\"token string\">'utf-8'</span>\nDEFAULT_CHARSET <span class=\"token operator\">=</span> <span class=\"token string\">'utf-8'</span>\nLANGUAGE_CODE <span class=\"token operator\">=</span> <span class=\"token string\">'zh-Hans'</span>\nTIME_ZONE <span class=\"token operator\">=</span> <span class=\"token string\">'Asia/Shanghai'</span>\n\n\n<span class=\"token triple-quoted-string string\">'''\nSecurity\n'''</span>\nCORS_ALLOW_CREDENTIALS <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\nCORS_ORIGIN_ALLOW_ALL <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\nCORS_ALLOW_METHODS <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'DELETE'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'OPTIONS'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'PATCH'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'PUT'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'VIEW'</span>\n<span class=\"token punctuation\">)</span>\nCORS_ALLOW_HEADERS <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'accept'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'accept-encoding'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'authorization'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'content-type'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'dnt'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'origin'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'user-agent'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'x-csrftoken'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'x-requested-with'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'idToken'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n\nALLOWED_HOSTS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">]</span>\n\n\n<span class=\"token triple-quoted-string string\">'''\nApplication definition\n'''</span>\nINSTALLED_APPS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'django.contrib.admin'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'django.contrib.auth'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'django.contrib.contenttypes'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'django.contrib.sessions'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'django.contrib.messages'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'django.contrib.staticfiles'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span>\n\nMIDDLEWARE <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'django.middleware.security.SecurityMiddleware'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'django.middleware.common.CommonMiddleware'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'django.middleware.csrf.CsrfViewMiddleware'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'django.contrib.messages.middleware.MessageMiddleware'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span>\n\nROOT_URLCONF <span class=\"token operator\">=</span> <span class=\"token string\">'main.urls'</span>\n\nTEMPLATES <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'BACKEND'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'django.template.backends.django.DjangoTemplates'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'DIRS'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>BASE_DIR <span class=\"token operator\">/</span> <span class=\"token string\">'templates'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'APP_DIRS'</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'OPTIONS'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">'context_processors'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">'django.template.context_processors.debug'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">'django.template.context_processors.request'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">'django.contrib.auth.context_processors.auth'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">'django.contrib.messages.context_processors.messages'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p><strong>main/settings/local.py</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span>base <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n\n\n<span class=\"token triple-quoted-string string\">'''\nBase Settings\n'''</span>\nDEBUG <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n\n\n<span class=\"token triple-quoted-string string\">'''\nStatic and media files\n'''</span>\nSTATIC_ROOT <span class=\"token operator\">=</span> BASE_DIR <span class=\"token operator\">/</span> <span class=\"token string\">'static'</span>\nMEDIA_ROOT <span class=\"token operator\">=</span> BASE_DIR <span class=\"token operator\">/</span> <span class=\"token string\">'upload'</span>\nSTATIC_URL <span class=\"token operator\">=</span> <span class=\"token string\">'/static/'</span>\nMEDIA_URL <span class=\"token operator\">=</span> <span class=\"token string\">'/media/'</span>\n\n\n<span class=\"token triple-quoted-string string\">'''\nDatabase\n'''</span>\nDATABASES <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'default'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'ENGINE'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'django.db.backends.sqlite3'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'NAME'</span><span class=\"token punctuation\">:</span> BASE_DIR <span class=\"token operator\">/</span> <span class=\"token string\">'db.sqlite3'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h5>main/settings/prod.py</h5>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span>base <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n\n\n<span class=\"token triple-quoted-string string\">'''\nBase Settings\n'''</span>\nDEBUG <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span>\n\n\n<span class=\"token triple-quoted-string string\">'''\nStatic and media files\n'''</span>\nSTATIC_ROOT <span class=\"token operator\">=</span> <span class=\"token string\">'/data/django_demo/static'</span>\nMEDIA_ROOT <span class=\"token operator\">=</span> <span class=\"token string\">'/data/django_demo/upload'</span>\nSTATIC_URL <span class=\"token operator\">=</span> <span class=\"token string\">'/static/django_demo/'</span>\nMEDIA_URL <span class=\"token operator\">=</span> <span class=\"token string\">'/media/django_demo/'</span>\n\n\n<span class=\"token triple-quoted-string string\">'''\nDatabase\n'''</span>\nDATABASES <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'default'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'ENGINE'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'django.db.backends.sqlite3'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'NAME'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'/data/django_demo/db.sqlite3'</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里可以看到本地调试的配置和生产环境的配置是不同的，具体的不同在于数据库、静态资源、上传资源位置不同。</p>\n<h4>跑起来自带 Admin 后台管理系统</h4>\n<p>首先要编写 <code class=\"language-text\">run.sh</code> 脚本，方便运行前设置一些环境变量。</p>\n<p><strong>run.sh</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token assign-left variable\">MODE</span><span class=\"token operator\">=</span><span class=\"token variable\">$1</span>\n\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">DJANGO_SETTINGS_MODULE</span><span class=\"token operator\">=</span>main.settings.local\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$MODE</span> <span class=\"token operator\">=</span> <span class=\"token string\">'makemigrations'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    python manage.py makemigrations\n<span class=\"token keyword\">elif</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$MODE</span> <span class=\"token operator\">=</span> <span class=\"token string\">'migrate'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    python manage.py migrate\n<span class=\"token keyword\">elif</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$MODE</span> <span class=\"token operator\">=</span> <span class=\"token string\">'collectstatic'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    python manage.py collectstatic\n<span class=\"token keyword\">elif</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$MODE</span> <span class=\"token operator\">=</span> <span class=\"token string\">'createsuperuser'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    python manage.py createsuperuser\n<span class=\"token keyword\">else</span>\n    python manage.py runserver <span class=\"token number\">0.0</span>.0.0:8000\n<span class=\"token keyword\">fi</span></code></pre></div>\n<p>执行以下命令后就可以登录 Django 自带的 admin 后台看看了。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">chmod</span> +x ./run.sh\n./run.sh migrate\n./run.sh collectstatic\n./run.sh createsuperuser\n./run.sh</code></pre></div>\n<h3>4. 部署</h3>\n<p>本地跑起来没啥问题了，就可以将项应用部署到服务器上了。</p>\n<h4>本地操作</h4>\n<p>编写 circus 配置文件。</p>\n<p><strong>circus.ini</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token selector\">[circus]</span>\n<span class=\"token constant\">check_delay</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> 5</span>\n<span class=\"token constant\">endpoint</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> tcp://127.0.0.1:5555</span>\n<span class=\"token constant\">pubsub_endpoint</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> tcp://127.0.0.1:5556</span>\n<span class=\"token constant\">statsd</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> true</span>\n<span class=\"token selector\">[env:web]</span>\n<span class=\"token constant\">LC_ALL</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>en_US.UTF-8</span>\n<span class=\"token constant\">LANG</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>en_US.UTF-8</span>\n<span class=\"token constant\">DJANGO_SETTINGS_MODUL</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>django_demo.settings.prod</span>\n<span class=\"token selector\">[watcher:web]</span>\n<span class=\"token constant\">working_dir</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> /opt/django_demo</span>\n<span class=\"token constant\">cmd</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> /usr/local/bin/uvicorn --fd $(circus.sockets.web) django_demo.asgi:application</span>\n<span class=\"token constant\">use_sockets</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> True</span>\n<span class=\"token constant\">copy_env</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> True</span>\n<span class=\"token constant\">numprocesses</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> 3</span>\n<span class=\"token constant\">autostart</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> True</span>\n<span class=\"token constant\">stdout_stream.class</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> FileStream</span>\n<span class=\"token constant\">stdout_stream.filename</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> /data/django_demo/logs/deploy.log</span>\n<span class=\"token constant\">stdout_stream.max_bytes</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> 10485760</span>\n<span class=\"token constant\">stdout_stream.backup_count</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> 4</span>\n<span class=\"token selector\">[socket:web]</span>\n<span class=\"token constant\">host</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> 127.0.0.1</span>\n<span class=\"token constant\">port</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> 8000</span></code></pre></div>\n<p>编写 <code class=\"language-text\">runp.sh</code> 文件。</p>\n<p><strong>runp.sh</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token assign-left variable\">MODE</span><span class=\"token operator\">=</span><span class=\"token variable\">$1</span>\n\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">DJANGO_SETTINGS_MODULE</span><span class=\"token operator\">=</span>main.settings.prod\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$MODE</span> <span class=\"token operator\">=</span> <span class=\"token string\">'makemigrations'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    python3.9 manage.py makemigrations\n<span class=\"token keyword\">elif</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$MODE</span> <span class=\"token operator\">=</span> <span class=\"token string\">'migrate'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    python3.9 manage.py migrate\n<span class=\"token keyword\">elif</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$MODE</span> <span class=\"token operator\">=</span> <span class=\"token string\">'collectstatic'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    python3.9 manage.py collectstatic\n<span class=\"token keyword\">elif</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$MODE</span> <span class=\"token operator\">=</span> <span class=\"token string\">'createsuperuser'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    python3.9 manage.py createsuperuser\n<span class=\"token keyword\">else</span>\n    python3.9 manage.py runserver <span class=\"token number\">0.0</span>.0.0:8000\n<span class=\"token keyword\">fi</span></code></pre></div>\n<p>导出本地依赖，并上传至 Github。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">pip freeze <span class=\"token operator\">></span> requirements.txt\n<span class=\"token function\">git</span> push <span class=\"token punctuation\">..</span>.</code></pre></div>\n<h4>服务器操作</h4>\n<p>远程登录服务器，下载代码。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> /opt\n<span class=\"token function\">git</span> clone xxx/django_demo\n<span class=\"token builtin class-name\">cd</span> django_demo</code></pre></div>\n<p>在服务器中直接安装 python3.9，安装过程视具体操作系统而定。</p>\n<p>安装 python 依赖。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">python3.9 -m pip <span class=\"token function\">install</span> -r requirements.txt\npython3.9 -m pip <span class=\"token function\">install</span> uvicorn circus</code></pre></div>\n<h5>配置 Nginx</h5>\n<p>创建 django_demo 的专属配置，并在 <code class=\"language-text\">nginx.conf</code> 中导入该配置。</p>\n<p><strong>django_demo.conf</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">server {\n    listen         80;\n    server_name    localhost;\n    charset UTF-8;\n\n    client_max_body_size 2000m;\n    client_body_buffer_size 20m;\n    client_body_temp_path /tmp/nginx/client_body_temp;\n\n    location ^~ /ws {\n        proxy_pass http://127.0.0.1:8000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection &quot;upgrade&quot;;\n    }\n\n    location ^~ /api {\n        proxy_pass http://127.0.0.1:8000;\n    }\n\n    location ^~ /django_demo {\n        proxy_pass http://127.0.0.1:8000;\n    }\n\n    location ^~ /static/ {\n        alias /data/django_demo/static/;\n        autoindex on;\n    }\n\n    location ^~ /media/ {\n        alias /data/django_demo/upload/;\n        autoindex on;\n    }\n}</code></pre></div>\n<h5>运行项目</h5>\n<p>在服务未运行时启动（一般都是服务已经在跑了，有改动后只需要 circusctl restart 就行）。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> -E <span class=\"token function\">env</span> <span class=\"token string\">\"DJANGO_SETTINGS_MODULE=main.settings.prod\"</span> circusd /opt/django_demo/circus.ini</code></pre></div>\n<p>如果它工作正常，你可以将其作为守护进程启动。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> -E <span class=\"token function\">env</span> <span class=\"token string\">\"DJANGO_SETTINGS_MODULE=main.settings.prod\"</span> circusd --daemon /opt/django_demo/circus.ini</code></pre></div>\n<p>重启/停止。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">circusctl restart/stop</code></pre></div>\n<p>Django 其他操作。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">./runp makemigrations/migrate/collectstatic/createsuperuser</code></pre></div>","frontmatter":{"title":"Django 从开发到部署","date":"March 28, 2021","description":"Django 项目搭建、部署。"}},"previous":{"fields":{"slug":"/django-user/"},"frontmatter":{"title":"Django -- 用户模块"}},"next":null},"pageContext":{"id":"287bc4a4-c027-5edf-9b1b-0a5e4fb1491c","previousPostId":"a8e3a9e3-4e2e-5586-bab5-991527f90849","nextPostId":null}},"staticQueryHashes":["2755755109","2841359383"]}